# Render Blueprint for Footnote Application
# https://render.com/docs/blueprint-spec
#
# IMPORTANT: After deploying, enable the pgvector extension on your database:
# 1. Go to your database in Render Dashboard
# 2. Go to the "Info" tab and click "Connect" via psql or external tool
# 3. Run: CREATE EXTENSION IF NOT EXISTS vector;

services:
  # Redis - Message broker for Celery
  - type: redis
    name: footnote-redis
    plan: starter
    ipAllowList: []

  # Frontend - Static React Application
  - type: web
    name: footnote-web
    runtime: static
    buildCommand: cd frontend && npm install && npm run build
    staticPublishPath: frontend/dist
    pullRequestPreviewsEnabled: true
    headers:
      - path: /*
        name: X-Frame-Options
        value: DENY
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: VITE_API_URL
        value: https://footnote-api.onrender.com

  # Backend - FastAPI Web Service (Docker)
  - type: web
    name: footnote-api
    runtime: docker
    plan: starter
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    healthCheckPath: /api/health
    preDeployCommand: "for f in database/migrations/*.sql; do psql $DATABASE_URL -f $f; done"
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: footnote-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: footnote-redis
          property: connectionString
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false
      - key: GOOGLE_REDIRECT_URI
        value: https://footnote-api.onrender.com/api/auth/google/callback
      - key: FIREWORKS_API_KEY
        sync: false
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: MISTRAL_API_KEY
        sync: false
      - key: SECRET_KEY
        generateValue: true
      - key: FRONTEND_URL
        value: https://footnote-web.onrender.com
      - key: CORS_ORIGINS
        value: '["https://footnote-web.onrender.com"]'

  # Celery Worker - Background Indexing Jobs (Docker)
  - type: worker
    name: footnote-celery-worker
    runtime: docker
    plan: starter
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    dockerCommand: uv run celery -A app.celery_app worker --loglevel=info --concurrency=8 --pool=threads -Q celery,indexing --without-gossip --without-mingle
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: footnote-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: footnote-redis
          property: connectionString
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false
      - key: FIREWORKS_API_KEY
        sync: false
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: MISTRAL_API_KEY
        sync: false

databases:
  - name: footnote-db
    plan: basic-256mb  # Options: free, basic-256mb, basic-1gb, basic-4gb, pro-4gb, etc.
    ipAllowList: []
